<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>SOTF Sample Data</title>
  <meta name="description" content="">
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet" />
  <script src='https://npmcdn.com/csv2geojson@latest/csv2geojson.js'></script>

</head>
  <style>

  body {
    margin: 0;
    padding: 0;
  }

  #map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
  }

  #menu {
    background: #fff;
    position: absolute;
    z-index: 1;
    top: 100px;
    right: 100px;
    border-radius: 3px;
    width: 120px;
    border: 1px solid rgba(0, 0, 0, 0.4);
    font-family: 'Open Sans', sans-serif;
  }

  #menu a {
    font-size: 13px;
    color: #404040;
    display: block;
    margin: 0;
    padding: 0;
    padding: 10px;
    text-decoration: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.25);
    text-align: center;
  }

  #menu a:last-child {
    border: none;
  }

  #menu a:hover {
    background-color: #f8f8f8;
    color: #404040;
  }

  #menu a.active {
    background-color: #3887be;
    color: #ffffff;
  }

  #menu a.active:hover {
    background: #3074a4;
  }

  </style>

  <body>

    <nav id="menu"></nav>
    <div id="map"></div>


    <script>

    mapboxgl.accessToken = 'pk.eyJ1IjoiZ2Zpc2tlLXdocmMiLCJhIjoiY2s4aXdpYWdnMGFwejNncW9ueTl1ODA5ZCJ9.cdEhouG-8PZe9n8fXPmYlA';

    var map = new mapboxgl.Map({
      container: 'map', // container id
      //style: "mapbox://styles/mapbox/satellite-v9", // satellite
      style: "mapbox://styles/mapbox/dark-v10", // dark
      center: [-95, 41], // starting position
      zoom: 4, // starting zoom
      //attributionControl: false,
      //showLogoBug: true
    });


    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    // Get the data from a Google Sheet and turn it into GeoJSON
    $(document).ready(function() {
      $.ajax({
        type: "GET",
        url: 'https://docs.google.com/spreadsheets/d/1jjnlIJLe2LOi8SZ_yOYak3u4n9KeT0qz2VIN0TtcSwk/gviz/tq?tqx=out:csv&sheet=Sheet1',
        dataType: "text",
        success: function(csvData) {
          makeGeoJSON(csvData);
        }
      });
    });


    function makeGeoJSON(csvData) {
      //console.log(csvData)
      csv2geojson.csv2geojson(csvData, {
          latfield: 'Latitude',
          lonfield: 'Longitude',
          delimiter: ','
        }, function(err, data) {
          //console.log(data)
    /*
          map.addSource('locations', {
            type: 'geojson',
            data: data,
            cluster: false,

          });
    */
          data.features.forEach((datum) => {
            datum.properties.AverageNitrate = parseInt(datum.properties.AverageNitrate)
          })
          data.features.forEach((datum) => {
            datum.properties.AveragePhosphate = parseInt(datum.properties.AveragePhosphate)
          })
          data.features.forEach((datum) => {
            datum.properties.AverageDOC = parseInt(datum.properties.AverageDOC)
          })

          //console.log(data)

          //Add the the Nitrate layer to the map
          map.addLayer({
            id: 'nitrate',
            type: 'circle',
            source: {
              type: 'geojson',
              data: data
            },
    //        layout: {
    //                // make layer invisible by default
    //                'visibility': 'none'
     //           },
            paint: {
              'circle-color': '#3366ff',
              'circle-stroke-width': 1,
              'circle-stroke-color': '#0033cc',
              'circle-opacity': 0.5,
              "circle-radius": {
                property: 'AverageNitrate',
                stops: [
                  [2, 5],
                  [1000, 25],
                  [8000, 55],
                ]
              }
            }

          });

          //Add the the Phospate layer to the map
          map.addLayer({
            id: 'phosphate',
            type: 'circle',
            source: {
              type: 'geojson',
              data: data
            },
            layout: {
                    // make layer invisible by default
                    'visibility': 'none',
                },
            paint: {
              'circle-color': '#cc9900',
              'circle-stroke-width': 1,
              'circle-stroke-color': '#b38600',
              'circle-opacity': 0.5,
              "circle-radius": {
                property: 'AveragePhosphate',
                stops: [
                  [1, 5],
                  [50, 25],
                  [250, 45],
                ]
              }
            }

          });

          //Add the the DOC layer to the map
              map.addLayer({
                id: 'doc',
                type: 'circle',
                source: {
                  type: 'geojson',
                  data: data
                },
               layout: {
                    // make layer invisible by default
                    'visibility': 'none'
                },
                paint: {
                  'circle-color': '#009933',
                  'circle-stroke-width': 1,
                  'circle-stroke-color': '#00802b',
                  'circle-opacity': 0.5,
                  "circle-radius": {
                    property: 'AverageDOC',
                    stops: [
                      [0, 2],
                      [1, 15],
                      [5, 35],
                    ]
                  }
                }

              });


        })
    }

        // After the last frame rendered before the map enters an "idle" state.
        map.on('idle', function() {
            // If these two layers have been added to the style,
            // add the toggle buttons.
            // Enumerate ids of the layers.
              var toggleableLayerIds = ['nitrate', 'phosphate', 'doc'];
              // Set up the corresponding toggle button for each layer.
              for (var i = 0; i < toggleableLayerIds.length; i++) {
                var id = toggleableLayerIds[i];
                if (!document.getElementById(id)) {
                  // Create a link.
                  var link = document.createElement('a');
                  link.id = id;
                  link.href = '#';
                  link.textContent = id;
                  link.className = 'active';
                  // Show or hide layer when the toggle is clicked.
                  link.onclick = function(e) {
                    var clickedLayer = this.textContent;
                    e.preventDefault();
                    e.stopPropagation();

                    var visibility = map.getLayoutProperty(
                      clickedLayer,
                      'visibility'
                    );

                    // Toggle layer visibility by changing the layout object's visibility property.
                    if (visibility === 'visible') {
                      map.setLayoutProperty(
                        clickedLayer,
                        'visibility',
                        'none'
                      );
                      this.className = '';
                    } else {
                      this.className = 'active';
                      map.setLayoutProperty(
                        clickedLayer,
                        'visibility',
                        'visible'
                      );
                    }
                  };

                  var layers = document.getElementById('menu');
                  layers.appendChild(link);




          // Create a popup, but don't add it to the map yet.
          var popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
          });
            map.on('mouseenter', 'csvData', function(e) {
            // Change the cursor style as a UI indicator.
            map.getCanvas().style.cursor = 'pointer';

            var coordinates = e.features[0].geometry.coordinates.slice();
            var SiteName = e.features[0].properties.SiteName;
            var AverageNitrate = e.features[0].properties.AverageNitrate;

            // Ensure that if the map is zoomed out such that
            // multiple copies of the feature are visible, the
            // popup appears over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            // Populate the popup and set its coordinates based on the feature found
            popup.setLngLat(coordinates).setHTML(
              '<h3>' + SiteName + '</h3>' + '<h4>' + '<b>' + 'Average Nitrate Value: ' + AverageNitrate + ' ' + '</b>' + '</h4>'
            ).addTo(map);
          });
          map.on('mouseleave', 'csvData', function() {
            map.getCanvas().style.cursor = '';
            popup.remove();
          });

                }
              }

          })
      </script>
  </body>

</html>
